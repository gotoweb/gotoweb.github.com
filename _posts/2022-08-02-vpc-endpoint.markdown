---
layout: post
title:  "NAT Gateway 대신 VPC Endpoint를 이용하기 (1)"
date:   2022-08-02 18:02:00 +0900
categories: AWS
---


## 개요

VPC 보안을 위해 EC2나 ECS, RDS와 같은 인스턴스를 프라이빗 서브넷에 위치시키면, 이에 대한 인터넷 트래픽을  위해 NAT 게이트웨이가 필요합니다.

다음은 기본적인 서브넷 분리에 따른 구성입니다.

![](/assets/images/2022-08-02-diagram-1.png)


## 인터넷 게이트웨이

인터넷 게이트웨이는 VPC 인스턴스가 인터넷에 연결되기 위해 반드시 필요합니다. 프라이빗과 퍼블릭 서브넷의 차이를 결정짓는 요소이기도 합니다. 프라이빗 서브넷과 달리 퍼블릭 서브넷은 모든 트래픽(0.0.0.0/0)에 대해 인터넷 게이트웨이로 트래픽이 라우팅 됩니다. 

> 인터넷 게이트웨이는 그 자체로도 NAT이며, 퍼블릭 IP를 갖고 있습니다.

## NAT 게이트웨이

NAT 게이트웨이는 AWS 관리하에 (mananged) 있는 NAT입니다. 보통, 퍼블릭 서브넷에 위치하여, 프라이빗 서브넷에 인터넷 트래픽을 전달하는 용도로 사용됩니다. 사용량과 대역폭에 대한 시간 당 요금으로 계산됩니다. 

> 고가용성을 위해 두 개 이상의 AZ에서 리소스가 운용될 경우, NAT 게이트웨이는 AZ 당 하나씩 만들어야 합니다. 

## 문제: NAT 게이트웨이가 너무 비싸요!

문제는 NAT 게이트웨이를 사용하기에는 비교적 비싸다는 점입니다. 특히 서버 인스턴스가 AWS 상에서 구동되는 경우, 서버 외부로 트래픽이 전달되기 보다는, AWS 내에 위치한 데이터베이스나, S3와 같은 서버리스 서비스를 사용하게 되는 경우가 많은데, 이 경우에는 굳이 NAT 게이트웨이 대신에 VPC 엔드포인트라는 기능을 사용하여, 상대적으로 발생하는 요금을 절약할 수 있습니다.

## VPC 엔드포인트

VPC 엔드포인트는 프라이빗 네트워크 상에서 작동되는 인스턴스가 AWS 서비스에 연결할 때에 NAT 게이트웨이를 통해 인터넷 망(퍼블릭 웹)을 이용하는 대신, 사용하려는 AWS 서비스와의 통신을 담당하는 접점을 만들어서 연결하도록 하는 VPC 구성요소입니다. 

예를 들어, EC2 서버가 S3로의 접근이 필요한 경우, NAT 게이트웨이를 붙여 연결하게 하는 대신, S3 VPC 엔드포인트를 하나 만들어, 이를 통해 통신을 하게 만들 수 있습니다. 

![](/assets/images/2022-08-02-diagram-2.png)

> 하나의 엔드포인트에 하나의 서비스만 지정할 수 있습니다.

## VPC 엔드포인트의 두가지 형태: 인터페이스와 게이트웨이

### 인터페이스

인터페이스는 네트워크 인터페이스(ENI)를 하나 생성합니다. NI이므로 IP 주소가 부여됩니다. 물론 프라이빗 서브넷에 위치해 있으므로 프라이빗 IP 주소입니다. 이 IP를 통해 AWS 서비스와 연결할 수 있습니다. 이 때 보안 그룹 지정은 필수입니다.

### 게이트웨이

대표적으로 S3와 DynamoDB가 게이트웨이를 이용하는 경우입니다. 게이트웨이는 (마치 인터넷 게이트웨이처럼) 라우트 테이블을 통해 서브넷과 연결할 수 있습니다.
